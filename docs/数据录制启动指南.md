# Leader-Follower X5 数据录制启动指南

## ⚠️ 重要：正确的启动顺序

数据录制系统依赖 DORA 数据流来获取摄像头和机械臂数据。**必须先启动 DORA 数据流，再启动数据录制**。

## 🚀 完整启动流程

### 步骤 1：启动 DORA 数据流

打开**第一个终端**，运行：

```bash
cd /home/dora/DoRobot-vr/operating_platform/teleop_vr
source ~/miniconda3/bin/activate dorobot
dora start dora_leader_follower_x5.yml
```

或者使用启动脚本：

```bash
cd /home/dora/DoRobot-vr/operating_platform/teleop_vr
./start_leader_follower.sh
```

**等待 10 秒**，让所有节点完全启动。

### 步骤 2：检查 DORA 节点状态

在**第二个终端**，运行：

```bash
source ~/miniconda3/bin/activate dorobot
dora list
```

应该看到以下节点都在运行：
- ✓ camera_top
- ✓ camera_wrist
- ✓ camera_right_realsense
- ✓ arm_leader
- ✓ arm_follower_x5
- ✓ adapter
- ✓ leader_follower_zeromq

### 步骤 3：启动数据录制

在**第二个终端**（保持第一个终端的 DORA 数据流运行），运行：

```bash
cd /home/dora/DoRobot-vr
source ~/miniconda3/bin/activate dorobot

# 启动数据录制
python3 -m operating_platform.core.record \\
    --robot-type leader_x5 \\
    --fps 30 \\
    --repo-id <your-repo-id> \\
    --root <dataset-path> \\
    --warmup-time-s 5 \\
    --episode-time-s 60 \\
    --reset-time-s 10
```

## 🔍 故障排查

### 问题：KeyError: 'top'

**原因**：DORA 数据流没有运行

**解决**：
1. 检查 DORA 是否运行：`dora list`
2. 如果没有运行，先启动 DORA 数据流（步骤 1）
3. 等待 10 秒
4. 再启动数据录制（步骤 3）

### 问题：DORA 节点启动失败

**可能原因**：
- 摄像头被占用
- 串口设备权限不足
- CAN 接口未配置

**解决**：
```bash
# 1. 停止所有 DORA 进程
dora stop
pkill -f dora

# 2. 检查摄像头
rs-enumerate-devices

# 3. 检查串口权限
sudo chmod 777 /dev/ttyACM0

# 4. 检查 CAN 接口
ip link show can0

# 5. 重新启动
./start_leader_follower.sh
```

### 问题：摄像头无图像

**检查**：
```bash
# 运行诊断工具
cd /home/dora/DoRobot-vr/operating_platform/teleop_vr
python3 diagnose_camera_connection.py

# 查看 DORA 日志
dora logs camera_top
dora logs camera_wrist
dora logs camera_right_realsense
```

## 📝 快速启动脚本

创建一个一键启动脚本：

```bash
#!/bin/bash
# 文件: start_recording.sh

set -e

echo "=========================================="
echo "Leader-Follower X5 数据录制启动"
echo "=========================================="
echo ""

# 激活环境
source ~/miniconda3/bin/activate dorobot

# 检查 DORA 是否运行
if ! dora list &>/dev/null; then
    echo "❌ DORA 数据流未运行"
    echo ""
    echo "请先在另一个终端启动 DORA 数据流:"
    echo "  cd /home/dora/DoRobot-vr/operating_platform/teleop_vr"
    echo "  ./start_leader_follower.sh"
    echo ""
    exit 1
fi

echo "✓ DORA 数据流正在运行"
echo ""

# 检查节点状态
echo "检查节点状态..."
dora list
echo ""

# 启动数据录制
echo "启动数据录制..."
cd /home/dora/DoRobot-vr

python3 -m operating_platform.core.record \\
    --robot-type leader_x5 \\
    --fps 30 \\
    --repo-id your-repo-id \\
    --root ./data \\
    --warmup-time-s 5 \\
    --episode-time-s 60 \\
    --reset-time-s 10
```

## 🎯 总结

**关键点**：
1. ✅ **先启动 DORA 数据流**（在第一个终端）
2. ⏱️ **等待 10 秒**（让节点完全启动）
3. ✅ **再启动数据录制**（在第二个终端）
4. 🔍 **遇到问题先检查** `dora list`

**常见错误**：
- ❌ 直接启动数据录制，没有先启动 DORA → KeyError: 'top'
- ❌ DORA 刚启动就立即录制 → 前几帧可能缺失数据
- ❌ 摄像头被其他程序占用 → DORA 节点启动失败

**正确流程**：
```
终端 1: DORA 数据流 (持续运行)
   ↓
等待 10 秒
   ↓
终端 2: 数据录制 (按需启动/停止)
```
