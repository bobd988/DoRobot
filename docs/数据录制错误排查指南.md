# 数据录制错误排查指南

## 错误现象

```
KeyError: 'top'
File "/home/dora/DoRobot-vr/operating_platform/utils/dataset.py", line 486
frame[key] = values[key.removeprefix(f"{prefix}.images.")]
```

## 错误原因

数据录制系统无法获取摄像头图像数据，导致 `obs_dict` 中缺少摄像头键（如 'top', 'wrist', 'right_realsense'）。

## 数据流路径

```
RealSense 摄像头
    ↓
DORA camera_top/wrist/right_realsense 节点
    ↓
DORA leader_follower_zeromq 节点
    ↓
ZeroMQ IPC Socket
    ↓
LeaderX5Manipulator.recv_images
    ↓
obs_dict['top'] / obs_dict['wrist'] / obs_dict['right_realsense']
    ↓
build_dataset_frame
```

**断裂点**: 数据在某个环节没有正确传递

## 排查步骤

### 1. 检查摄像头硬件连接

```bash
# 检查 RealSense 摄像头是否被识别
rs-enumerate-devices

# 应该看到 3 个设备，序列号分别为:
# - 405622073811 (top)
# - 347622073355 (wrist)
# - 346522074669 (right_realsense)
```

**如果没有检测到摄像头**:
- 检查 USB 连接
- 重新插拔摄像头
- 检查 USB 端口供电（建议使用 USB 3.0 端口）
- 重启系统

### 2. 运行摄像头诊断工具

```bash
cd /home/dora/DoRobot-vr/operating_platform/teleop_vr
python3 diagnose_camera_connection.py
```

这个工具会：
- 检查所有 RealSense 摄像头
- 验证序列号是否匹配配置
- 尝试启动每个摄像头并获取图像
- 报告任何问题

### 3. 检查 DORA 数据流状态

```bash
# 查看 DORA 数据流日志
dora logs camera_top
dora logs camera_wrist
dora logs camera_right_realsense
dora logs leader_follower_zeromq
```

**常见错误**:
- `Failed to open device` - 摄像头被占用或权限不足
- `Timeout waiting for frames` - 摄像头无响应
- `Device not found` - 序列号不匹配

### 4. 检查 ZeroMQ 连接

```bash
# 检查 ZeroMQ IPC socket 是否存在
ls -l /tmp/dora-zeromq-leader-follower-*

# 应该看到:
# /tmp/dora-zeromq-leader-follower-image
# /tmp/dora-zeromq-leader-follower-joint
```

### 5. 测试单个摄像头

```bash
# 使用 realsense-viewer 测试摄像头
realsense-viewer

# 或使用 ffplay 测试 RGB 通道
ffplay -f v4l2 -video_size 640x480 -framerate 30 /dev/video8   # top
ffplay -f v4l2 -video_size 640x480 -framerate 30 /dev/video20  # wrist
ffplay -f v4l2 -video_size 640x480 -framerate 30 /dev/video14  # right_realsense
```

## 常见问题及解决方案

### 问题 1: 摄像头被其他进程占用

**症状**: DORA 日志显示 "Device is busy" 或 "Failed to open device"

**解决方案**:
```bash
# 查找占用摄像头的进程
lsof /dev/video* | grep video

# 关闭占用的进程
kill -9 <PID>

# 或重启 DORA 数据流
dora stop
dora start dora_leader_follower_x5.yml
```

### 问题 2: 摄像头权限不足

**症状**: "Permission denied" 错误

**解决方案**:
```bash
# 添加当前用户到 video 组
sudo usermod -a -G video $USER

# 重新登录或运行
newgrp video

# 或临时修改权限
sudo chmod 666 /dev/video*
```

### 问题 3: USB 带宽不足

**症状**: 部分摄像头无法启动，或图像卡顿

**解决方案**:
- 将摄像头分散到不同的 USB 控制器
- 降低摄像头分辨率或帧率
- 使用 USB 3.0 端口

### 问题 4: 序列号不匹配（重新上电后）

**症状**: DORA 日志显示 "Device not found"

**解决方案**:
```bash
# 1. 获取当前摄像头序列号
rs-enumerate-devices | grep "Serial Number"

# 2. 更新配置文件
# 编辑 operating_platform/robot/robots/configs.py (第751-771行)
# 编辑 operating_platform/teleop_vr/dora_leader_follower_x5.yml (第21, 34, 47行)

# 3. 重启 DORA 数据流
```

参考文档: `/home/dora/DoRobot-vr/docs/设备配置修改指南.md`

### 问题 5: DORA 节点启动失败

**症状**: 数据录制时持续报 KeyError

**解决方案**:
```bash
# 1. 停止所有 DORA 进程
dora stop
pkill -f dora

# 2. 清理 ZeroMQ socket
rm -f /tmp/dora-zeromq-*

# 3. 重新启动 DORA 数据流
cd /home/dora/DoRobot-vr/operating_platform/teleop_vr
dora start dora_leader_follower_x5.yml

# 4. 等待所有节点启动（约 5-10 秒）

# 5. 检查节点状态
dora list
```

### 问题 6: 数据录制启动过早

**症状**: 前几帧报错，然后正常

**解决方案**:
- 在启动数据录制前，等待 DORA 数据流完全启动（约 10 秒）
- 检查 LeaderX5Manipulator.connect() 是否等待足够时间

## 预防措施

1. **启动顺序**:
   ```bash
   # 1. 先启动 DORA 数据流
   dora start dora_leader_follower_x5.yml

   # 2. 等待 10 秒，确保所有节点启动
   sleep 10

   # 3. 再启动数据录制
   python3 -m operating_platform.core.record ...
   ```

2. **定期检查**:
   ```bash
   # 检查摄像头连接
   rs-enumerate-devices

   # 检查 DORA 节点状态
   dora list

   # 检查 ZeroMQ socket
   ls -l /tmp/dora-zeromq-*
   ```

3. **日志监控**:
   ```bash
   # 实时查看 DORA 日志
   dora logs -f camera_top
   dora logs -f leader_follower_zeromq
   ```

## 快速修复脚本

```bash
#!/bin/bash
# 快速修复摄像头连接问题

echo "停止 DORA 数据流..."
dora stop
pkill -f dora

echo "清理 ZeroMQ socket..."
rm -f /tmp/dora-zeromq-*

echo "检查摄像头连接..."
rs-enumerate-devices | grep -E "(Serial Number|Device info)"

echo "重新启动 DORA 数据流..."
cd /home/dora/DoRobot-vr/operating_platform/teleop_vr
dora start dora_leader_follower_x5.yml

echo "等待节点启动..."
sleep 10

echo "检查节点状态..."
dora list

echo "完成！现在可以启动数据录制了。"
```

保存为 `fix_camera_connection.sh`，然后运行：
```bash
chmod +x fix_camera_connection.sh
./fix_camera_connection.sh
```

## 总结

**不是重新上电导致的设备问题**，因为：
- RealSense 摄像头的序列号是硬件固定的，不会因为重新上电而改变
- 配置文件中的序列号与实际设备匹配

**真正的问题是**：
- DORA 摄像头节点没有正常启动或工作
- 数据没有通过 ZeroMQ 传递到数据录制系统

**建议操作**：
1. 运行 `diagnose_camera_connection.py` 检查摄像头
2. 运行 `fix_camera_connection.sh` 重启 DORA 数据流
3. 等待 10 秒后再启动数据录制
