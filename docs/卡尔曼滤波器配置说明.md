# 卡尔曼滤波器配置说明

## 已实施的改进

### 1. 滤波器切换功能

现在可以在EMA和卡尔曼滤波器之间切换：

```yaml
# 在 dora_leader_follower_x5.yml 中配置
env:
  FILTER_TYPE: "kalman"  # 或 "ema"
```

### 2. 卡尔曼滤波器参数

为每个关节配置了不同的噪声参数（根据负载调整）：

```python
kalman_filters = [
    KalmanFilter1D(process_noise=0.01, measurement_noise=2.0),  # joint_0 基座
    KalmanFilter1D(process_noise=0.01, measurement_noise=1.0),  # joint_1 肩部
    KalmanFilter1D(process_noise=0.01, measurement_noise=0.8),  # joint_2 肘部
    KalmanFilter1D(process_noise=0.01, measurement_noise=0.5),  # joint_3-5 腕部
]
```

**参数说明**：
- `process_noise (Q)`: 过程噪声，模型不确定性（固定0.01）
- `measurement_noise (R)`: 测量噪声，传感器噪声
  - 基座：2.0（负载大，噪声大）
  - 肩部：1.0（中等负载）
  - 肘部：0.8（中等负载）
  - 腕部：0.5（负载小，噪声小）

### 3. 卡尔曼滤波器的优势

相比EMA滤波器：

| 特性 | EMA | 卡尔曼 |
|------|-----|--------|
| 平滑效果 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 响应速度 | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 自适应性 | ❌ | ✅ |
| 噪声抑制 | 固定 | 动态调整 |

**卡尔曼滤波器的特点**：
- 自适应调整：根据测量不确定性动态调整滤波强度
- 更好的平衡：在平滑和响应之间自动找到最佳平衡点
- 预测能力：可以预测运动趋势，减少延迟感

## 使用方法

### 启动系统（使用卡尔曼滤波器）

```bash
cd /home/dora/DoRobot-vr
bash operating_platform/teleop_vr/start_leader_follower.sh
```

系统会自动使用卡尔曼滤波器（FILTER_TYPE="kalman"）。

### 切换回EMA滤波器

如果卡尔曼效果不理想，可以切换回EMA：

```yaml
# 修改 dora_leader_follower_x5.yml
env:
  FILTER_TYPE: "ema"
  EMA_ALPHA: "0.25"
```

## 调参指南

### 如果还有抖动

降低对应关节的 `measurement_noise`（更信任滤波器）：

```python
# 在 leader_follower_adapter.py 中修改
KalmanFilter1D(process_noise=0.01, measurement_noise=1.5)  # 从2.0降到1.5
```

### 如果响应太慢

提高对应关节的 `measurement_noise`（更信任测量值）：

```python
KalmanFilter1D(process_noise=0.01, measurement_noise=3.0)  # 从2.0提高到3.0
```

### 参数调整原则

```
measurement_noise 越小 → 越平滑，但响应越慢
measurement_noise 越大 → 响应越快，但可能抖动
```

**推荐调整范围**：
- 基座：1.5 - 3.0
- 肩肘：0.8 - 1.5
- 腕部：0.3 - 0.8

## 当前配置总结

```python
# 滤波器
FILTER_TYPE = "kalman"

# 死区阈值
deadband_thresholds = [
    2.5,  # joint_0 (基座)
    1.0,  # joint_1 (肩部)
    0.7,  # joint_2 (肘部)
    1.5,  # joint_3-5 (腕部)
]

# 卡尔曼滤波器噪声参数
measurement_noise = [2.0, 1.0, 0.8, 0.5, 0.5, 0.5]
```

## 预期效果

使用卡尔曼滤波器后：
- ✅ 抖动明显减少（自适应噪声抑制）
- ✅ 响应速度提升（动态调整滤波强度）
- ✅ 更自然的运动感（预测能力）
- ✅ 不需要频繁调参（自适应特性）

## 对比测试

建议测试以下场景：

1. **慢速移动基座** - 观察是否还抖动
2. **快速移动基座** - 观察响应速度
3. **前伸动作** - 观察延迟感
4. **精细操作** - 观察末端稳定性

如果卡尔曼效果更好，可以删除EMA相关代码；如果EMA更好，可以切换回去。
