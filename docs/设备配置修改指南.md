# Leader-Follower X5 设备配置修改指南

本文档说明当硬件设备发生变化时，需要修改哪些配置文件。

## 📋 目录

- [摄像头序列号配置](#摄像头序列号配置)
- [主臂端口配置](#主臂端口配置)
- [从臂CAN端口配置](#从臂can端口配置)
- [快速检查命令](#快速检查命令)

---

## 📷 摄像头序列号配置

### 当前配置

系统使用 **3个 Intel RealSense D435I 摄像头**：

| 摄像头 | 当前序列号 | 用途 |
|--------|-----------|------|
| 顶部视角 (top) | 405622073811 | 俯视工作区域 |
| 腕部视角 (wrist) | 347622073355 | 机械臂末端视角 |
| 右侧视角 (right_realsense) | 346522074669 | 侧面视角 |

### 需要修改的文件

#### 1. Python配置文件（用于数据录制）

**文件路径**: `operating_platform/robot/robots/configs.py`

**修改位置**: 第 751-771 行（LeaderX5RobotConfig 类）

```python
cameras: dict[str, CameraConfig] = field(
    default_factory=lambda: {
        "top": IntelRealSenseCameraConfig(
            serial_number="405622073811",  # ← 修改这里：顶部摄像头序列号
            fps=30,
            width=640,
            height=480,
        ),
        "wrist": IntelRealSenseCameraConfig(
            serial_number="347622073355",  # ← 修改这里：腕部摄像头序列号
            fps=30,
            width=640,
            height=480,
        ),
        "right_realsense": IntelRealSenseCameraConfig(
            serial_number="346522074669",  # ← 修改这里：右侧摄像头序列号
            fps=30,
            width=640,
            height=480,
        ),
    }
)
```

#### 2. DORA数据流配置文件

**文件路径**: `operating_platform/teleop_vr/dora_leader_follower_x5.yml`

**修改位置**: 第 14-50 行（camera节点配置）

```yaml
nodes:
  # 相机节点 - RealSense (顶部视角)
  - id: camera_top
    path: /home/dora/DoRobot/operating_platform/robot/components/camera_rgbd_realsense/main.py
    env:
      DEVICE_SERIAL: "405622073811"  # ← 修改这里：顶部摄像头序列号
      IMAGE_WIDTH: "640"
      IMAGE_HEIGHT: "480"

  # 相机节点 - RealSense (腕部视角)
  - id: camera_wrist
    path: /home/dora/DoRobot/operating_platform/robot/components/camera_rgbd_realsense/main.py
    env:
      DEVICE_SERIAL: "347622073355"  # ← 修改这里：腕部摄像头序列号
      IMAGE_WIDTH: "640"
      IMAGE_HEIGHT: "480"

  # 相机节点 - RealSense (右侧视角)
  - id: camera_right_realsense
    path: /home/dora/DoRobot/operating_platform/robot/components/camera_rgbd_realsense/main.py
    env:
      DEVICE_SERIAL: "346522074669"  # ← 修改这里：右侧摄像头序列号
      IMAGE_WIDTH: "640"
      IMAGE_HEIGHT: "480"
```

---

## 🦾 主臂端口配置

### 当前配置

- **设备**: Feetech STS3215 舵机（7个：6关节 + 1夹爪）
- **当前端口**: `/dev/ttyACM0`
- **协议**: Feetech

### 需要修改的文件

#### 1. Python配置文件

**文件路径**: `operating_platform/robot/robots/configs.py`

**修改位置**: 第 729-745 行（LeaderX5RobotConfig 类）

```python
leader_arms: dict[str, MotorsBusConfig] = field(
    default_factory=lambda: {
        "main": FeetechMotorsBusConfig(
            port="/dev/ttyACM0",  # ← 修改这里：主臂串口端口
            motors={
                "joint_0": [1, "sts3215"],
                "joint_1": [2, "sts3215"],
                "joint_2": [3, "sts3215"],
                "joint_3": [4, "sts3215"],
                "joint_4": [5, "sts3215"],
                "joint_5": [6, "sts3215"],
                "gripper": [7, "sts3215"],
            },
        ),
    }
)
```

#### 2. DORA数据流配置文件

**文件路径**: `operating_platform/teleop_vr/dora_leader_follower_x5.yml`

**修改位置**: 第 52-66 行（arm_leader节点配置）

```yaml
# 主臂节点 - 读取Feetech电机位置
- id: arm_leader
  path: /home/dora/miniconda3/envs/dorobot/bin/python3
  args: -u /home/dora/DoRobot/operating_platform/robot/components/arm_normal_so101_v1/main.py
  inputs:
    get_joint: dora/timer/millis/50  # 20Hz
  outputs:
    - joint
  env:
    GET_DEVICE_FROM: PORT
    PORT: /dev/ttyACM0  # ← 修改这里：主臂串口端口
    ARM_NAME: LeaderX5
    ARM_ROLE: leader
    MOTOR_PROTOCOL: feetech
    CALIBRATION_DIR: /home/dora/DoRobot/operating_platform/robot/components/arm_normal_so101_v1/.calibration/
```

---

## 🤖 从臂CAN端口配置

### 当前配置

- **设备**: ARX-X5 机械臂（6关节 + 1夹爪）
- **当前端口**: `can0`
- **状态**: UP,LOWER_UP（运行中）

### 需要修改的文件

#### DORA数据流配置文件

**文件路径**: `operating_platform/teleop_vr/dora_leader_follower_x5.yml`

**修改位置**: 第 94-123 行（arm_follower_x5节点配置）

```yaml
# 从臂节点 - 控制ARX X5
- id: arm_follower_x5
  path: /home/dora/miniconda3/envs/dorobot/bin/python3
  args: -u /home/dora/DoRobot-vr/operating_platform/teleop_vr/robot_driver_arx_x5.py
  inputs:
    action_joint: adapter/action_joint
  outputs:
    - joint
  env:
    # X5 SDK路径
    X5_SDK_PATH: "/home/dora/DoRobot-before/ARX_X5/py/arx_x5_python"

    # 共享库路径
    LD_LIBRARY_PATH: "/home/dora/DoRobot-before/ARX_X5/py/arx_x5_python/bimanual/api/arx_x5_src:/home/dora/DoRobot-before/ARX_X5/py/arx_x5_python/bimanual/api:/opt/ros/noetic/lib:/opt/ros/humble/lib:/usr/local/lib"

    # Python模块路径
    PYTHONPATH: "/home/dora/DoRobot-before/ARX_X5/py/arx_x5_python/bimanual/api:/home/dora/DoRobot-before/ARX_X5/py/arx_x5_python/bimanual/api/arx_x5_python"

    # CAN配置
    CAN_PORT: "can0"  # ← 修改这里：从臂CAN端口（如改为can1）
    ARM_TYPE: "0"     # 0=普通X5
    NUM_JOINTS: "6"
    DT: "0.05"

    # 夹爪映射
    GRIPPER_SCALE: "10.0"  # 主臂夹爪(0-100) -> X5夹爪(0-1000)

    # 日志控制
    LOG_EVERY_N: "50"
```

> **注意**: ARX-X5从臂没有在Python配置文件中配置，因为它通过DORA节点和CAN总线直接控制，不使用lerobot的motor bus系统。

---

## 🔍 快速检查命令

### 检查摄像头序列号

```bash
# 列出所有RealSense摄像头及其序列号
rs-enumerate-devices | grep -E "(Device|Serial Number)"
```

**输出示例**:
```
Device info:
    Serial Number                 : 	347622073355
Device info:
    Serial Number                 : 	346522074669
Device info:
    Serial Number                 : 	405622073811
```

### 检查主臂串口设备

```bash
# 列出所有ttyACM设备
ls -l /dev/ttyACM*
```

**输出示例**:
```
crwxrwxrwx 1 root dialout 166, 0  2月  5 10:04 /dev/ttyACM0
crwxrwxrwx 1 root dialout 166, 1  2月  5 10:06 /dev/ttyACM1
```

### 检查从臂CAN接口

```bash
# 检查CAN接口状态
ip link show can0
```

**输出示例**:
```
5: can0: <NOARP,UP,LOWER_UP> mtu 16 qdisc pfifo_fast state UP mode DEFAULT group default qlen 10
    link/can
```

如果CAN接口未启动，使用以下命令启动：
```bash
sudo ip link set can0 up type can bitrate 1000000
```

### 检查所有视频设备

```bash
# 列出所有视频设备
ls -l /dev/video* | head -20

# 查看特定视频设备的详细信息
v4l2-ctl --device=/dev/video4 --info
```

---

## 📝 修改步骤总结

### 当摄像头更换时

1. 运行 `rs-enumerate-devices | grep "Serial Number"` 获取新序列号
2. 修改 `operating_platform/robot/robots/configs.py` 中的序列号（第751-771行）
3. 修改 `operating_platform/teleop_vr/dora_leader_follower_x5.yml` 中的序列号（第21、34、47行）
4. 重启DORA数据流和数据录制程序

### 当主臂端口更换时

1. 运行 `ls -l /dev/ttyACM*` 确认新端口号
2. 修改 `operating_platform/robot/robots/configs.py` 中的端口（第732行）
3. 修改 `operating_platform/teleop_vr/dora_leader_follower_x5.yml` 中的端口（第62行）
4. 重启DORA数据流和数据录制程序

### 当从臂CAN端口更换时

1. 运行 `ip link show` 确认新CAN接口名称
2. 修改 `operating_platform/teleop_vr/dora_leader_follower_x5.yml` 中的CAN端口（第113行）
3. 确保新CAN接口已启动：`sudo ip link set can1 up type can bitrate 1000000`
4. 重启DORA数据流

---

## ⚠️ 注意事项

1. **修改后必须重启**: 所有配置修改后，必须重启DORA数据流才能生效
2. **两处都要改**: 摄像头和主臂配置需要在两个文件中同时修改
3. **序列号不要加引号**: Python配置文件中的序列号是字符串，但YAML文件中需要加引号
4. **CAN接口权限**: 确保当前用户有权限访问CAN接口（通常需要sudo或加入can组）
5. **备份配置**: 修改前建议备份原配置文件

---

## 📞 故障排查

### 摄像头无法连接

- 检查USB连接是否稳定
- 运行 `rs-enumerate-devices` 确认摄像头被系统识别
- 检查序列号是否正确匹配

### 主臂无法通信

- 检查串口设备是否存在：`ls -l /dev/ttyACM*`
- 检查串口权限：`sudo chmod 777 /dev/ttyACM0`
- 检查波特率配置是否正确

### 从臂无法控制

- 检查CAN接口状态：`ip link show can0`
- 检查CAN接口是否启动：状态应为 `UP,LOWER_UP`
- 检查X5 SDK路径是否正确
- 查看DORA日志：`dora logs arm_follower_x5`

---

**文档版本**: v1.0
**最后更新**: 2026-02-05
**适用系统**: Leader-Follower X5 Teleoperation System

